/**
 * Ponto de Entrada da API NestJS - Nexa Oper
 * (versÃ£o com CORS unificado + HSTS condicional + trust proxy opcional)
 */

import * as dotenv from 'dotenv';
import { resolve } from 'path';

// Carregar .env do diretÃ³rio raiz do projeto API
const envPath = resolve(
  __dirname.includes('dist')
    ? __dirname.replace('/dist', '')
    : __dirname.replace('/src', ''),
  '.env'
);
dotenv.config({ path: envPath });

import { Logger, ValidationPipe } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
import * as express from 'express';
import helmet from 'helmet';
import { NextFunction, Request, Response } from 'express';
import { AppModule } from './app.module';
import { AllExceptionsFilter } from '@common/filters/all-exceptions.filter';
import { StandardLogger } from '@common/utils/logger';
import { ensurePortFree } from '@common/utils/ports';

/** Util: interpreta CORS_ORIGINS como JSON array ou CSV; sem valor => permissivo */
function parseCors(): string[] | true {
  const raw = process.env.CORS_ORIGINS?.trim();
  if (!raw) return true; // permissivo (atenÃ§Ã£o em produÃ§Ã£o)
  try {
    const arr = raw.startsWith('[') ? JSON.parse(raw) : raw.split(',');
    const list = arr.map((s: string) => s.trim()).filter(Boolean);
    return list.length ? list : true;
  } catch {
    return raw
      .split(',')
      .map(s => s.trim())
      .filter(Boolean);
  }
}

async function bootstrap(): Promise<void> {
  const logger = new StandardLogger('Bootstrap');

  try {
    logger.log('ðŸš€ Iniciando aplicaÃ§Ã£o Nexa Oper API...');

    // Porta
    const port = parseInt(process.env.PORT ?? '3001', 10);

    // Em dev, garante a porta livre (mata processo preso)
    if (process.env.NODE_ENV !== 'production') {
      await ensurePortFree(port, msg => logger.log(msg));
    } else {
      logger.log('â„¹ï¸ VerificaÃ§Ã£o de porta/kill desabilitada em produÃ§Ã£o');
    }

    // Cria app
    const app = await NestFactory.create(AppModule, {
      logger: ['log', 'error', 'warn', 'debug'],
      abortOnError: false,
    });
    (global as any).NEST_APP = app;

    const expressApp = app.getHttpAdapter().getInstance();

    // Opcional: confia no proxy quando houver balanceador/Nginx/ALB
    // Ative com TRUST_PROXY=true
    if (process.env.TRUST_PROXY === 'true') {
      expressApp.set('trust proxy', 1);
      logger.log('âœ… trust proxy habilitado');
    }

    // Rota crua para health bÃ¡sico
    expressApp.get('/__ping', (_req: Request, res: Response) =>
      res.status(200).send('ok')
    );

    // Logger simples por request
    expressApp.use((req: Request, res: Response, next: NextFunction) => {
      const t0 = Date.now();
      console.log(`[REQ] ${req.method} ${req.url}`);
      res.on('finish', () => {
        console.log(
          `[RES] ${req.method} ${req.url} -> ${res.statusCode} (${Date.now() - t0}ms)`
        );
      });
      next();
    });

    // SeguranÃ§a base
    const useHsts =
      process.env.NODE_ENV === 'production' && process.env.HAS_HTTPS === 'true';
    app.use(
      helmet({
        contentSecurityPolicy: false, // para nÃ£o quebrar Swagger no dev
        crossOriginEmbedderPolicy: false,
        hsts: useHsts,
      })
    );
    if (useHsts) logger.log('âœ… HSTS habilitado (produÃ§Ã£o + HTTPS verdadeiro)');

    // Parsing (envios grandes via Multer)
    app.use(express.json({ limit: '2mb' }));
    app.use(express.urlencoded({ extended: true, limit: '2mb' }));
    logger.log('âœ… Parsing JSON/URL configurado: limite de 2MB');

    // CORS (fonte Ãºnica)
    const allowed = parseCors();
    app.enableCors({
      origin: (
        origin: string | undefined,
        callback: (err: Error | null, success: boolean) => void
      ) => {
        // Sem Origin (curl, prom, healthchecks) => libera
        if (!origin) return callback(null, true);
        if (allowed === true) return callback(null, true);

        // Match exato
        if (allowed.includes(origin)) return callback(null, true);

        // Tenta normalizar para protocolo+host
        try {
          const { protocol, host } = new URL(origin);
          const base = `${protocol}//${host}`;
          if (allowed.includes(base)) return callback(null, true);
        } catch {
          /* ignore */
        }

        return callback(new Error('CORS: Origin not allowed'), false);
      },
      methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
      allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
      credentials: true,
      maxAge: 86400,
    });

    if (allowed === true) {
      logger.warn(
        'âš ï¸ CORS PERMISSIVO (todas as origens). Use CORS_ORIGINS em produÃ§Ã£o.'
      );
    } else {
      logger.log(
        `âœ… CORS restrito a ${allowed.length} origem(ens): ${allowed.join(', ')}`
      );
    }

    // Timeout de requests
    app.use((req: Request, res: Response, next: NextFunction) => {
      const timeoutMs = 60_000; // 1 minuto
      req.setTimeout(timeoutMs);
      res.setTimeout(timeoutMs);
      next();
    });
    logger.log('âœ… Timeout de requisiÃ§Ãµes configurado para 1 minuto');

    // ValidaÃ§Ã£o global
    app.useGlobalPipes(
      new ValidationPipe({
        transform: true,
        whitelist: true,
        forbidNonWhitelisted: false,
        validateCustomDecorators: false,
        skipMissingProperties: false,
        skipNullProperties: false,
        skipUndefinedProperties: false,
      })
    );
    logger.log('âœ… ValidaÃ§Ã£o global de DTOs configurada');

    // Filtro global de exceÃ§Ãµes
    app.useGlobalFilters(new AllExceptionsFilter());
    logger.log('âœ… Filtro global de exceÃ§Ãµes configurado');

    // Swagger sÃ³ fora de produÃ§Ã£o
    if (process.env.NODE_ENV !== 'production') {
      const config = new DocumentBuilder()
        .setTitle('Nexa Oper API')
        .setDescription('API para gerenciamento de operaÃ§Ãµes da Nexa')
        .setVersion('1.0')
        .addTag('apr', 'AnÃ¡lise Preliminar de Risco')
        .addTag('checklist', 'Checklists de SeguranÃ§a')
        .addTag('database', 'OperaÃ§Ãµes de Banco de Dados')
        .addBearerAuth()
        .build();

      const document = SwaggerModule.createDocument(app, config);
      SwaggerModule.setup('api/docs', app, document);
      logger.log('âœ… DocumentaÃ§Ã£o Swagger disponÃ­vel em /api/docs');
    }

    // Prefixo + shutdown
    app.setGlobalPrefix('api');
    app.enableShutdownHooks();
    logger.log('âœ… Prefixo global "api" configurado');

    // Graceful shutdown
    const gracefulShutdown = async (signal: string) => {
      logger.log(`ðŸ”„ Recebido sinal ${signal}. Iniciando graceful shutdown...`);
      try {
        const shutdownTimeout = setTimeout(() => {
          logger.error('âŒ Timeout no graceful shutdown. ForÃ§ando saÃ­da...');
          process.exit(1);
        }, 30_000);

        await app.close();
        clearTimeout(shutdownTimeout);
        logger.log('âœ… AplicaÃ§Ã£o finalizada com sucesso');
        process.exit(0);
      } catch (error) {
        logger.error('âŒ Erro durante graceful shutdown:', error);
        process.exit(1);
      }
    };
    process.on('SIGTERM', () => void gracefulShutdown('SIGTERM'));
    process.on('SIGINT', () => void gracefulShutdown('SIGINT'));
    process.on('SIGHUP', () => void gracefulShutdown('SIGHUP'));

    // Sobe server
    await app.listen(port, '0.0.0.0');

    // Logs finais
    logger.log('ðŸŽ‰ API Nexa Oper iniciada com sucesso!');
    logger.log(`ðŸŒ Porta: ${port}`);
    logger.log(`ðŸ“± Ambiente: ${process.env.NODE_ENV ?? 'development'}`);
    logger.log(`ðŸ”— Base URL: http://localhost:${port}/api`);
    if (process.env.NODE_ENV !== 'production') {
      logger.log(`ðŸ“š Docs: http://localhost:${port}/api/docs`);
    }
  } catch (error) {
    logger.error('âŒ Falha crÃ­tica na inicializaÃ§Ã£o da aplicaÃ§Ã£o:', error);
    process.exit(1);
  }
}

bootstrap().catch((error: unknown) => {
  const logger = new Logger('Bootstrap');
  logger.error('ðŸ’¥ Erro fatal durante inicializaÃ§Ã£o:', error);
  logger.error('Stack trace completo:', error);
  process.exit(1);
});
